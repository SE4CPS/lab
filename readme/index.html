<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>releasetrain.io â€” Updates Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Software component version releases feed" />

  <!-- Inline CSS only -->
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a21;
      --muted: #9aa3af;
      --text: #e5e7eb;
      --brand: #60a5fa;
      --line: #2a2f3a;
      --chip: #1f2430;
      --chipText: #e5e7eb;
      --focus: #a5b4fc;
      --bad: #ef4444;
      --warn: #f59e0b;
      --ok: #22c55e;
      --reddit: #ff4500;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f7fb;
        --panel: #ffffff;
        --muted: #6b7280;
        --text: #0f172a;
        --brand: #2563eb;
        --line: #e5e7eb;
        --chip: #eef2ff;
        --chipText: #1f2937;
        --focus: #4f46e5;
        --bad: #dc2626;
        --warn: #d97706;
        --ok: #16a34a;
        --reddit: #ff4500;
      }
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Top bar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--panel);
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .brand {
      font-weight: 700;
      letter-spacing: .2px
    }

    .brand b {
      color: var(--brand)
    }

    .spacer {
      flex: 1 1 auto
    }

    /* KPIs + controls */
    .kpis {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .kpi {
      background: var(--chip);
      color: var(--chipText);
      border: 1px solid var(--line);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px
    }

    .kpi em {
      font-style: normal;
      color: var(--brand);
      font-weight: 700
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    input[type="text"],
    button {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 8px 10px;
      font: inherit;
    }

    input[type="text"] {
      min-width: 260px
    }

    input[type="text"]:focus,
    button:focus {
      outline: 2px solid var(--focus);
      outline-offset: 2px
    }

    button {
      background: var(--brand);
      color: #fff;
      border-color: transparent;
      cursor: pointer;
      font-weight: 600
    }

    button.secondary {
      background: transparent;
      color: var(--text);
      border-color: var(--line)
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px
    }

    /* Feed panel */
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px
    }

    .panel header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 8px
    }

    .status {
      color: var(--muted);
      font-size: 12px
    }

    /* Grouping by date */
    .feedGroup {
      border: 1px solid var(--line);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px
    }

    summary {
      cursor: pointer;
      padding: 10px 12px;
      list-style: none;
      user-select: none;
      font-weight: 700;
      background: var(--chip)
    }

    summary::-webkit-details-marker {
      display: none
    }

    summary .meta {
      font-weight: 400;
      color: var(--muted)
    }

    .updates {
      padding: 8px 10px
    }

    /* Items */
    .item {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px dashed var(--line)
    }

    .item:last-child {
      border-bottom: none
    }

    .avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1px solid var(--line);
      object-fit: cover
    }

    .titleRow {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    .titleRow a {
      color: var(--brand);
      text-decoration: none;
      font-weight: 700
    }

    .titleRow a:focus {
      outline: 2px solid var(--focus);
      outline-offset: 2px
    }

    .meta {
      color: var(--muted);
      font-size: 12px
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px
    }

    .chip {
      background: var(--chip);
      color: var(--chipText);
      border: 1px solid var(--line);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px
    }

    .chip.bad {
      background: rgba(239, 68, 68, .12);
      color: var(--bad);
      border-color: rgba(239, 68, 68, .35)
    }

    .chip.warn {
      background: rgba(245, 158, 11, .12);
      color: var(--warn);
      border-color: rgba(245, 158, 11, .35)
    }

    .chip.ok {
      background: rgba(34, 197, 94, .12);
      color: var(--ok);
      border-color: rgba(34, 197, 94, .35)
    }

    /* Reddit attachments */
    .redditWrap {
      margin-top: 6px;
      padding: 8px;
      border: 1px dashed var(--line);
      border-radius: 8px;
      background: transparent
    }

    .redditHead {
      font-weight: 700;
      color: var(--reddit);
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    .redditList {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .redditItem a {
      color: var(--text);
      text-decoration: none
    }

    .redditItem a:hover {
      text-decoration: underline
    }

    .redditMeta {
      font-size: 12px;
      color: var(--muted)
    }

    .sr-only {
      position: absolute !important;
      width: 1px;
      height: 1px;
      margin: -1px;
      border: 0;
      padding: 0;
      clip: rect(0 0 0 0);
      overflow: hidden
    }
  </style>
</head>

<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="brand" aria-label="Releasetrain brand">Releasetrain <b>v3.1.0</b></div>

    <div class="kpis" role="status" aria-live="polite">
      <div class="kpi">Page Versions: <em id="kpi-page">0</em></div>
      <div class="kpi" id="kpi-range">Date Range: <em>â€”</em></div>
    </div>

    <div class="spacer" aria-hidden="true"></div>

    <!-- Only component filter + buttons (no API field) -->
    <form id="filterForm" class="controls" aria-label="Filter versions">
      <label for="components" class="sr-only">Components (comma separated)</label>
      <input id="components" name="components" type="text" placeholder="Filter: linux, android, nginxâ€¦" />
      <button type="submit">Apply</button>
      <button type="button" id="clearBtn" class="secondary">Clear</button>
    </form>
  </div>

  <!-- Feed panel -->
  <main>
    <section class="panel" aria-label="Updates Feed">
      <header>
        <h2 style="margin:0;font-size:16px">Recent Updates</h2>
        <div id="status" class="status">Idle</div>
      </header>
      <div id="feed"></div>
    </section>
  </main>

  <!-- App (no external libraries) -->
  <script>
    // ------- Small, modular client -------

    const API_BASE = "https://releasetrain.io/api/"; // fixed as requested

    const $ = s => document.querySelector(s);

    // Utilities
    const fmtDateToken = (yyyymmdd) => {
      if (!/^\d{8}$/.test(yyyymmdd)) return yyyymmdd || "Unknown";
      const y = +yyyymmdd.slice(0, 4), m = +yyyymmdd.slice(4, 6) - 1, d = +yyyymmdd.slice(6, 8);
      const dt = new Date(y, m, d);
      const today = new Date(), yest = new Date(); yest.setDate(today.getDate() - 1);
      if (dt.toDateString() === today.toDateString()) return "Today";
      if (dt.toDateString() === yest.toDateString()) return "Yesterday";
      return dt.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric", year: "numeric" });
    };
    const safe = (v, d = "") => v == null ? d : v;
    const uniq = (arr) => Array.from(new Set(arr.filter(Boolean)));
    const avatarFor = (item) => {
      const url = (item.versionUrl || "") + "";
      if (url.includes("github.com/")) { const user = url.split("/")[3]; if (user) return `https://github.com/${user}.png`; }
      if (url.startsWith("https://nvd.nist.gov/")) return "./img/cve.png";
      return "./img/default.png";
    };
    const shortTime = (iso) => {
      try { return new Date(iso).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }); }
      catch { return ""; }
    };

    // API layer (feed + reddit only)
    const Api = {
      async versions(csv) {
        const q = csv ? `?q=${encodeURIComponent(csv)}` : "";
        const endpoint = `${API_BASE}v/${q}`;
        const res = await fetch(endpoint, { headers: { Accept: "application/json" } });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText} @ ${endpoint}`);
        const json = await res.json();
        return json.versions || [];
      },
      async reddit() {
        const endpoint = `${API_BASE}reddit?isUpdateRelated=false&showCount=true&limit=10`;
        const res = await fetch(endpoint, { headers: { Accept: "application/json" } });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText} @ ${endpoint}`);
        const json = await res.json();
        // API returns {data:[...]} per your sample
        const list = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
        // index by subreddit (lowercase)
        const map = new Map();
        list.forEach(p => {
          const key = (p.subreddit || "").toLowerCase();
          if (!key) return;
          if (!map.has(key)) map.set(key, []);
          map.get(key).push(p);
        });
        // sort each subreddit by freshness then score
        for (const [k, arr] of map.entries()) {
          arr.sort((a, b) => {
            const da = +new Date(a.created_utc || 0), db = +new Date(b.created_utc || 0);
            if (db !== da) return db - da;
            return (b.score || 0) - (a.score || 0);
          });
        }
        return map;
      }
    };

    // Group versions by friendly date headings
    function groupByDate(list) {
      const map = new Map();
      list.forEach(v => {
        const d = safe(v.versionReleaseDate, "").slice(0, 8);
        if (!d) return;
        const key = fmtDateToken(d);
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(v);
      });
      const order = Array.from(map.keys()).sort((a, b) => {
        if (a === "Today") return -1; if (b === "Today") return 1;
        if (a === "Yesterday") return -1; if (b === "Yesterday") return 1;
        return new Date(b) - new Date(a);
      });
      return order.map(k => ({ date: k, items: map.get(k) }));
    }

    function chip(text, kind) {
      const cls = kind === 'bad' ? 'chip bad' : kind === 'warn' ? 'chip warn' : kind === 'ok' ? 'chip ok' : 'chip';
      return `<span class="${cls}">${text}</span>`;
    }

    // Build a small reddit block for a version (up to N posts)
    function renderRedditBlock(version, redditIndex, maxPosts = 2) {
      // possible keys to match
      const name = (safe(version.versionProductName, "") || "").toLowerCase();
      const types = (version.classification && Array.isArray(version.classification.componentType)) ? version.classification.componentType.map(v => String(v).toLowerCase()) : [];
      const tags = Array.isArray(version.versionSearchTags) ? version.versionSearchTags.map(v => String(v).toLowerCase()) : [];
      const keys = uniq([name, ...types, ...tags]);

      let posts = [];
      keys.forEach(k => {
        if (redditIndex.has(k)) posts = posts.concat(redditIndex.get(k));
      });

      // de-dup by redditId
      const seen = new Set();
      posts = posts.filter(p => { if (seen.has(p.redditId)) return false; seen.add(p.redditId); return true; });
      posts = posts.slice(0, maxPosts);
      if (posts.length === 0) return "";

      const items = posts.map(p => {
        const when = p.created_utc ? new Date(p.created_utc).toLocaleString() : "";
        return `
          <div class="redditItem">
            <a href="${p.url}" target="_blank" rel="noopener">${p.title}</a>
            <div class="redditMeta">r/${p.subreddit} â€¢ â–² ${p.score || 0} â€¢ ðŸ’¬ ${p.num_comments || 0} â€¢ ${when}</div>
          </div>`;
      }).join("");

      return `
        <div class="redditWrap" role="region" aria-label="Related Reddit discussions">
          <div class="redditHead">Reddit matches</div>
          <div class="redditList">${items}</div>
        </div>`;
    }

    function renderFeed(list, redditIndex) {
      const feed = $("#feed");
      feed.innerHTML = "";
      $("#kpi-page").textContent = list.length;

      // Date range KPI
      if (list.length) {
        const all = list.map(v => v.versionReleaseDate).filter(Boolean).sort();
        $("#kpi-range").innerHTML = `Date Range: <em>${fmtDateToken(all[0])} â€“ ${fmtDateToken(all[all.length - 1])}</em>`;
      } else {
        $("#kpi-range").innerHTML = `Date Range: <em>â€”</em>`;
      }

      const groups = groupByDate(list);
      if (!groups.length) {
        feed.innerHTML = `<div class="meta">No results found for the current filter.</div>`;
        return;
      }

      for (const g of groups) {
        const det = document.createElement("details");
        det.className = "feedGroup";
        det.open = feed.children.length === 0;

        const sum = document.createElement("summary");
        sum.innerHTML = `${g.date} <span class="meta">(${g.items.length} updates)</span>`;
        det.appendChild(sum);

        const wrap = document.createElement("div");
        wrap.className = "updates";

        g.items.forEach(it => {
          const row = document.createElement("article");
          row.className = "item";

          // avatar
          const img = document.createElement("img");
          img.className = "avatar";
          img.alt = (safe(it.versionProductName, "")).slice(0, 40);
          img.src = avatarFor(it);
          row.appendChild(img);

          // body
          const body = document.createElement("div");

          // title line
          const title = document.createElement("div");
          title.className = "titleRow";
          const bestUrl = (it.versionUrl && it.versionUrl.startsWith("http")) ? it.versionUrl
            : (it.versionReleaseNotes && it.versionReleaseNotes.startsWith("http")) ? it.versionReleaseNotes
              : "#";
          const link = document.createElement("a");
          const label = `${safe(it.versionProductName, "").slice(0, 28)}${it.versionNumber ? (" " + it.versionNumber) : ""}`;
          link.href = bestUrl; link.target = "_blank"; link.rel = "noopener"; link.textContent = label;
          title.appendChild(link);

          const ts = safe(it.versionTimestampLastUpdate, "");
          if (ts) {
            const t = document.createElement("span");
            t.className = "meta";
            t.textContent = `(${shortTime(ts)})`;
            title.appendChild(t);
          }
          body.appendChild(title);

          // chips
          const chips = document.createElement("div");
          chips.className = "chips";

          const ch = (safe(it.versionReleaseChannel, "other") + "").toLowerCase();
          const color = ch === "major" ? "ok" : ch === "patch" ? "warn" : ch === "minor" ? "" : "bad";
          chips.insertAdjacentHTML("beforeend", chip(ch || "other", color));
          if (it.isCve) chips.insertAdjacentHTML("beforeend", chip("cve", "bad"));

          const compTypes = (it.classification && Array.isArray(it.classification.componentType)) ? it.classification.componentType : [];
          compTypes.filter(v => v && v !== "UNKNOWN").forEach(v => chips.insertAdjacentHTML("beforeend", chip(String(v).toLowerCase(), "")));

          const secTypes = (it.classification && Array.isArray(it.classification.securityType)) ? it.classification.securityType : [];
          secTypes.filter(v => v && v !== "UNKNOWN").forEach(v => chips.insertAdjacentHTML("beforeend", chip(String(v).toLowerCase(), "bad")));

          const brkTypes = (it.classification && Array.isArray(it.classification.breakingType)) ? it.classification.breakingType : [];
          brkTypes.filter(v => v && v !== "UNKNOWN").forEach(v => chips.insertAdjacentHTML("beforeend", chip(String(v).toLowerCase(), "warn")));

          // release notes teaser (optional; keep compact)
          if (it.versionReleaseComments) {
            const meta = document.createElement("div");
            meta.className = "meta";
            meta.textContent = it.versionReleaseComments;
            body.appendChild(meta);
          }

          body.appendChild(chips);

          // Reddit attach (matched by product name / component type / search tags)
          const redditHTML = redditIndex ? renderRedditBlock(it, redditIndex, 2) : "";
          if (redditHTML) { body.insertAdjacentHTML("beforeend", redditHTML); }

          row.appendChild(body);
          wrap.appendChild(row);
        });

        det.appendChild(wrap);
        feed.appendChild(det);
      }
    }

    // Boot sequence
    async function boot(csv) {
      $("#status").textContent = "Loadingâ€¦";
      try {
        const [versions, redditIndex] = await Promise.all([
          Api.versions(csv),
          Api.reddit().catch(() => null) // Reddit is best-effort
        ]);
        renderFeed(versions, redditIndex);
        $("#status").textContent = `Loaded ${versions.length} items`;
      } catch (err) {
        console.error(err);
        $("#feed").innerHTML = `<div class="meta">Error: ${err.message}</div>`;
        $("#status").textContent = "Failed to load (check network/CORS)";
      }
    }

    // Wire controls
    const initialQ = new URLSearchParams(location.search).get("q") || "";
    $("#components").value = initialQ;
    $("#filterForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const csv = $("#components").value.trim().replace(/\s+/g, '');
      const newUrl = new URL(location.href);
      if (csv) newUrl.searchParams.set("q", csv); else newUrl.searchParams.delete("q");
      history.replaceState({}, "", newUrl.toString());
      boot(csv);
    });
    $("#clearBtn").addEventListener("click", () => {
      $("#components").value = "";
      const u = new URL(location.href);
      u.searchParams.delete("q");
      history.replaceState({}, "", u.toString());
      boot("");
    });

    // Initial load (uses your fixed API base)
    boot(initialQ);
  </script>
</body>

</html>